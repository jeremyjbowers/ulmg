{% extends 'base.html' %}

{% load ulmg_tags %}

{% block content %}
{% include 'includes/team_topper.html' %}

<style type="text/css">
    a.action-add-tag:hover { cursor: pointer; }
    span.note-control { cursor: pointer }
    tr.hide { display: none; }
    span.filter { cursor:pointer; }
    /* tbody.list-group tr td {background-color: white;} */
    tbody.list-group tr:nth-child(16n) td {border-bottom:3px solid #555; }
    tbody.list-group tr:nth-child(n+81) td {background-color: #eee; border-bottom: none;}
    tbody.list-group tr.minors td { background-color: #f0fdf4; }
    .selected-tag { background-color: #16a34a; color: white; }
    tr.my-pick td{
        font-weight: bold;
        background-color: lightyellow;
    }
    /* Make tier drop targets larger, especially when empty */
    tbody.tier-list {
        min-height: 3rem;
    }
</style>

<!-- Simple tab navigation -->
<div class="border-b border-gray-300 mb-4">
    <div class="flex space-x-4 pb-2">
        <a href="/teams/{{ team.abbreviation|lower }}/" class="underline">Roster{% if num_owned %} ({{ num_owned }}){% endif %}</a>
        <a href="/teams/{{ team.abbreviation|lower }}/other/" class="underline">Trades & picks</a>
        {% if draft_type == "aa" %}
        <span class="font-bold">AA Draft</span>
        {% else %}
        <a href="/my/wishlist/draft/beta/" class="underline">AA Draft</a>
        {% endif %}
        {% if draft_type == "open" %}
        <span class="font-bold">Open Draft</span>
        {% else %}
        <a href="/my/midseason/draft/" class="underline">Open Draft</a>
        {% endif %}
    </div>
</div>

<div class="flex gap-4">
    <!-- Tier board -->
    <div class="flex-1 overflow-x-auto">
        <div class="mb-2 flex justify-between items-center">
            <h3 class="text-sm font-bold">Tier board (drag between tiers; order within tier is fine-grained rank)</h3>
            <div class="text-xs text-gray-600">
                <span class="mr-4">Draft: {{ draft_year }} {{ draft_season }} {{ draft_type|upper }}</span>
                <label>
                    <input type="checkbox" id="hide-drafted-toggle" class="mr-1" checked>
                    Hide drafted players
                </label>
            </div>
        </div>
        <div id="tier-board" class="grid grid-cols-5 gap-3">
            {% for tier in tiers %}
            <div class="border border-gray-300 rounded bg-gray-50 flex flex-col min-h-[200px]">
                <div class="px-2 py-1 border-b border-gray-300 bg-gray-100 flex items-center justify-between">
                    <span class="text-xs font-semibold">{{ tier.label }}</span>
                    <span class="text-[10px] text-gray-600" data-tier-count="{{ tier.id }}">({{ tier.players|length }})</span>
                </div>
                <div class="overflow-y-auto max-h-[75vh]">
                    <table class="w-full text-[11px] border-collapse">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-1 px-1">#</th>
                                <th class="text-left py-1 px-1">Player</th>
                                <th class="text-center py-1 px-1">Age</th>
                                <th class="text-center py-1 px-1">Lvl</th>
                                <th class="text-center py-1 px-1">Pos</th>
                                <th class="text-center py-1 px-1">Org</th>
                            </tr>
                        </thead>
                        <tbody id="tier-{{ tier.id }}-players" class="tier-list" data-tier="{{ tier.id }}">
                            {% for p in tier.players %}
                            <tr data-playername="{{ p.player.name }}" data-playerid="{{ p.player.id }}"
                                class="list-group-item border-b border-gray-100 level-{{ p.player.get_best_stat_season.clean_classification }}">
                                <td id="rank-{{ p.player.id }}" class="py-1 px-1 align-top">
                                    <span>{% if p.rank == 0 %}-{% else %}{{ p.rank }}{% endif %}</span>
                                    <span class="pickowner text-[10px] text-gray-500 block"></span>
                                </td>
                                {% include "includes/my/player_name.html" %}
                                <td class="text-center py-1 px-1 align-top">{{ p.player.age|default_if_none:"-" }}</td>
                                <td class="text-center py-1 px-1 align-top">{{ p.player.level }}</td>
                                <td class="text-center py-1 px-1 align-top">{{ p.player.position }}</td>
                                <td class="text-center py-1 px-1 align-top">{{ p.player.mlb_org|default_if_none:"-" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>

        {% if untiered_players %}
        <div class="mt-4">
            <h3 class="text-xs font-bold mb-1">Untiered players (drag into a tier)</h3>
            <table class="w-full text-[11px] border-collapse">
                <thead>
                    <tr class="border-b border-gray-300">
                        <th class="text-left py-1 px-1">Rank</th>
                        <th class="text-left py-1 px-1">Player</th>
                        <th class="text-center py-1 px-1">Age</th>
                        <th class="text-center py-1 px-1">Level</th>
                        <th class="text-center py-1 px-1">Pos</th>
                        <th class="text-center py-1 px-1">Org</th>
                    </tr>
                </thead>
                <tbody id="untiered-players" class="tier-list" data-tier="0">
                    {% for p in untiered_players %}
                    <tr data-playername="{{ p.player.name }}" data-playerid="{{ p.player.id }}"
                        class="list-group-item border-b border-gray-100 level-{{ p.player.get_best_stat_season.clean_classification }}">
                        <td id="rank-{{ p.player.id }}" class="py-1 px-1">
                            <span>{% if p.rank == 0 %}-{% else %}{{ p.rank }}{% endif %}</span>
                            <span class="pickowner text-[10px] text-gray-500 block"></span>
                        </td>
                        {% include "includes/my/player_name.html" %}
                        <td class="text-center py-1 px-1">{{ p.player.age|default_if_none:"-" }}</td>
                        <td class="text-center py-1 px-1">{{ p.player.level }}</td>
                        <td class="text-center py-1 px-1">{{ p.player.position }}</td>
                        <td class="text-center py-1 px-1">{{ p.player.mlb_org|default_if_none:"-" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
</div>

<!-- {% include "includes/notes_modal.html" %} -->
{% endblock %}
        
{% block extrascript %}
<script src="//SortableJS.github.io/Sortable/Sortable.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>

{% if user.is_authenticated %}
<script type="text/javascript">
    // Flag used by wishlistjs to alter behaviour on draft wishlist pages
    window.WISHLIST_DRAFT_PAGE = true;
</script>
<script type="text/javascript">
$(function(){
    // Tiered drag-and-drop using Sortable across multiple tier lists
    var update_server = function(update_list) {
        if (update_list.length === 0) {
            return;
        }
        $.ajax({
            method: "POST",
            url: '/api/v1/wishlist/bulk/',
            data: JSON.stringify(update_list),
            success: function(response){
                console.log("Wishlist bulk update:", response);
            }
        });
    };

    var recompute_all_ranks = function() {
        var update_list = [];

        $('.tier-list').each(function(){
            var $tierBody = $(this);
            var tier = parseInt($tierBody.data('tier')) || 0;
            var idx = 0;

            $tierBody.children('tr.list-group-item').each(function(){
                var $row = $(this);
                var playerid = $row.data('playerid');
                var name = $row.data('playername');

                // Only tier 1-5 get ranked within a tier; untiered (0) keep global rank display but no tier
                var rankCell = $('#rank-' + playerid + ' span').first();
                if (tier >= 1 && tier <= 5) {
                    idx += 1;
                    $row.attr('data-rank', idx);
                    if (rankCell.length) {
                        rankCell.text(idx);
                    }
                    update_list.push({
                        'playerid': playerid,
                        'rank': idx,
                        'tier': tier,
                        'name': name
                    });
                } else {
                    // Untiered: keep tier null/0, preserve existing rank display
                    update_list.push({
                        'playerid': playerid,
                        'tier': null,
                        'name': name
                    });
                }
            });

            // Update tier counts in headers if present
            if (tier >= 1 && tier <= 5) {
                var $countEl = $('[data-tier-count="' + tier + '"]');
                if ($countEl.length) {
                    $countEl.text('(' + idx + ')');
                }
            }
        });

        update_server(update_list);
    };

    var on_sort_end = function(evt) {
        recompute_all_ranks();
    };

    // Initialize Sortable on each tier list (including untiered, but untiered has tier 0)
    $('.tier-list').each(function(){
        Sortable.create(this, {
            group: 'wishlist-tiers',
            animation: 150,
            onEnd: on_sort_end
        });
    });
});
</script>

{% include "includes/my/wishlistjs.html" %}

<script type="text/javascript">
    $(function(){
    
        var persist_note_handler = function(el) {
            el.preventDefault();
            $el = $(this);

            var playerid = $el.attr('data-playerid');
            var note_text =  $('#note-textarea').val()

            $.ajax({
                type: "POST",
                data: {note: note_text},
                url: '/api/v1/wishlist/note/add/' + playerid + '/',
                success: function(response){
                    window.location.reload();
                }
            });

        }

        var close_modal_handler = function(el) {
            el.preventDefault();
            $el = $(this);
    
            var modalid = $el.parent('div').toggleClass('is-active');        
        }
    
        var note_modal_handler = function(el) {
            el.preventDefault();
            $el = $(this);
    
            var playerid = $el.parent('div').attr('data-playerid');
            var note_text = $el.parent('div').attr('data-note-text');
            var playername = $el.parent('div').attr('data-playername');

            $('#modal-title').html(playername);
            $('#note-textarea').val(note_text)
            $('#modal-notes').toggleClass('is-active');
            $('#persist-note').attr('data-playerid', playerid);
            
        }

        $('body').on('click', '#persist-note', persist_note_handler);
        $('body').on('click', 'span.note-control', note_modal_handler);
        $('body').on('click', 'button.modal-close', close_modal_handler);
        $('body').on('click', 'div.modal-background', close_modal_handler);
    });
</script>

<script type="text/javascript">
    $(function(){
        // Poll draft status and mark drafted players dynamically
        var draftYear = {{ draft_year }};
        var draftSeason = "{{ draft_season }}";
        var draftType = "{{ draft_type }}";
        var draftedPlayers = {};

        var apply_drafted_state = function(playerId, teamAbbr) {
            var selector = 'tr.list-group-item[data-playerid="' + playerId + '"]';
            var $rows = $(selector);
            if ($rows.length === 0) {
                return;
            }

            $rows.addClass('drafted');
            $rows.each(function(){
                var $row = $(this);
                var $ownerSpan = $row.find('.pickowner');
                if ($ownerSpan.length && teamAbbr) {
                    $ownerSpan.text(teamAbbr.toUpperCase());
                }
            });

            if ($('#hide-drafted-toggle').is(':checked')) {
                $rows.addClass('hide');
            }
        };

        var refresh_hide_toggle = function() {
            var hide = $('#hide-drafted-toggle').is(':checked');
            $('tr.list-group-item.drafted').each(function(){
                if (hide) {
                    $(this).addClass('hide');
                } else {
                    $(this).removeClass('hide');
                }
            });
        };

        $('#hide-drafted-toggle').on('change', function(){
            refresh_hide_toggle();
        });

        var poll_draft_status = function() {
            var url = '/api/v1/draft/watch/' + draftYear + '/' + draftSeason + '/' + draftType + '/';
            $.ajax({
                type: "GET",
                url: url,
                success: function(response){
                    if (!response.made_picks) {
                        return;
                    }
                    $.each(response.made_picks, function(idx, pick){
                        if (pick.player_id && !draftedPlayers[pick.player_id]) {
                            draftedPlayers[pick.player_id] = true;
                            apply_drafted_state(pick.player_id, pick.team);
                        }
                    });
                }
            });
        };

        // Initial poll and then repeat every 15 seconds
        poll_draft_status();
        setInterval(poll_draft_status, 15000);
    });
</script>
{% endif %}

{% endblock %}