{% extends 'base.html' %}

{% load ulmg_tags %}

{% block content %}
{% include 'includes/team_topper.html' %}

<style type="text/css">
    a.action-add-tag:hover { cursor: pointer; }
    span.note-control { cursor: pointer }
    tr.hide { display: none; }
    span.filter { cursor:pointer; }
    /* tbody.list-group tr td {background-color: white;} */
    tbody.list-group tr:nth-child(16n) td {border-bottom:3px solid #555; }
    tbody.list-group tr:nth-child(n+81) td {background-color: #eee; border-bottom: none;}
    tbody.list-group tr.minors td { background-color: #f0fdf4; }
    .selected-tag { background-color: #16a34a; color: white; }
    tr.my-pick td{
        font-weight: bold;
        background-color: lightyellow;
    }
    /* Make tier drop targets larger, especially when empty */
    tbody.tier-list {
        min-height: 3rem;
    }
    /* Hide tier assignment buttons once a player has been moved into a tier */
    tbody[id^="tier-"] .tier-assign-cell {
        display: none;
    }
    /* Visual indicator for full tiers */
    .tier-full {
        border-color: #dc2626;
    }
    .tier-full tbody.tier-list {
        background-color: #fef2f2;
    }
    /* Make watched section drop target more visible when empty */
    #watched-section tbody.tier-list {
        min-height: 3rem;
        background-color: #f9fafb;
    }
    #watched-section tbody.tier-list:empty::after {
        content: "Drop players here to remove from tiers";
        display: block;
        padding: 1rem;
        text-align: center;
        color: #9ca3af;
        font-style: italic;
        font-size: 10px;
    }
</style>

<!-- Simple tab navigation -->
<div class="border-b border-gray-300 mb-4">
    <div class="flex space-x-4 pb-2">
        <a href="/teams/{{ team.abbreviation|lower }}/" class="underline">Roster{% if num_owned %} ({{ num_owned }}){% endif %}</a>
        <a href="/teams/{{ team.abbreviation|lower }}/other/" class="underline">Trades & picks</a>
        {% if draft_type == "aa" %}
        <span class="font-bold">AA Draft</span>
        {% else %}
        <a href="/my/wishlist/draft/beta/" class="underline">AA Draft</a>
        {% endif %}
        {% if draft_type == "open" %}
        <span class="font-bold">Open Draft</span>
        {% else %}
        <a href="/my/{{ current_season_type }}/draft/" class="underline">Open Draft</a>
        {% endif %}
    </div>
</div>

<div class="flex gap-4">
    <!-- Tier board -->
    <div class="flex-1 overflow-x-auto">
        <div class="mb-2 flex justify-between items-center">
            <h3 class="text-sm font-bold">Tier board (drag between tiers; max 20 players per tier)</h3>
            <div class="text-xs text-gray-600">
                <span class="mr-4">Draft: {{ draft_year }} {{ draft_season }} {{ draft_type|upper }}</span>
                <label>
                    <input type="checkbox" id="hide-drafted-toggle" class="mr-1" checked>
                    Hide drafted players
                </label>
            </div>
        </div>
        <div id="tier-board" class="grid grid-cols-5 gap-3">
            {% for tier in tiers %}
            <div class="border border-gray-300 rounded bg-gray-50 flex flex-col min-h-[200px] {% if tier.players|length >= 20 %}tier-full{% endif %}" data-tier-id="{{ tier.id }}">
                <div class="px-2 py-1 border-b border-gray-300 bg-gray-100 flex items-center justify-between {% if tier.players|length >= 20 %}bg-red-100 border-red-300{% endif %}">
                    <span class="text-xs font-semibold">{{ tier.label }}</span>
                    <span class="text-[10px] {% if tier.players|length >= 20 %}text-red-600 font-bold{% else %}text-gray-600{% endif %}" data-tier-count="{{ tier.id }}">{{ tier.players|length }}/20</span>
                </div>
                <div class="overflow-y-auto max-h-[75vh]">
                    <table class="w-full text-[11px] border-collapse">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-left py-1 px-1">Player</th>
                                <th class="text-center py-1 px-1">Age</th>
                                {% if draft_type != "aa" %}
                                <th class="text-center py-1 px-1">Lvl</th>
                                {% endif %}
                                <th class="text-center py-1 px-1">Pos</th>
                                <th class="text-center py-1 px-1">Org</th>
                            </tr>
                        </thead>
                        <tbody id="tier-{{ tier.id }}-players" class="tier-list" data-tier="{{ tier.id }}" data-max-size="20">
                            {% for p in tier.players %}
                            <tr data-playername="{{ p.player.name }}" data-playerid="{{ p.player.id }}"
                                class="list-group-item border-b border-gray-100 level-{{ p.player.get_best_stat_season.clean_classification }}">
                                {% include "includes/my/player_name.html" %}
                                <td class="text-center py-1 px-1 align-top">{{ p.player.age|default_if_none:"-" }}</td>
                                {% if draft_type != "aa" %}
                                <td class="text-center py-1 px-1 align-top">{{ p.player.level }}</td>
                                {% endif %}
                                <td class="text-center py-1 px-1 align-top">{{ p.player.position }}</td>
                                <td class="text-center py-1 px-1 align-top">
                                    {% if p.player.current_mlb_org %}
                                        {{ p.player.current_mlb_org }}
                                    {% elif p.player.get_best_stat_season and p.player.get_best_stat_season.mlb_org %}
                                        {{ p.player.get_best_stat_season.mlb_org }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Watched players section - always present and visible (even when empty) so players can be dragged into it -->
        <div class="mt-4" id="watched-section">
            <h3 class="text-xs font-bold mb-1">Watched players (drag here to remove from tiers, or drag into a tier)</h3>
            <table class="w-full text-[11px] border-collapse">
            <thead>
                <tr class="border-b border-gray-300">
                        <th class="text-left py-1 px-1">Player</th>
                        <th class="text-center py-1 px-1">Age</th>
                        {% if draft_type != "aa" %}
                        <th class="text-center py-1 px-1">Level</th>
                        {% endif %}
                        <th class="text-center py-1 px-1">Pos</th>
                        <th class="text-center py-1 px-1">Org</th>
                        <th class="text-center py-1 px-1">Tier</th>
                </tr>
            </thead>
                <tbody id="untiered-players" class="tier-list" data-tier="0">
                    {% for p in untiered_players %}
                    <tr data-playername="{{ p.player.name }}" data-playerid="{{ p.player.id }}"
                        class="list-group-item border-b border-gray-100 level-{{ p.player.get_best_stat_season.clean_classification }}">
                        {% include "includes/my/player_name.html" %}
                        <td class="text-center py-1 px-1">{{ p.player.age|default_if_none:"-" }}</td>
                        {% if draft_type != "aa" %}
                        <td class="text-center py-1 px-1">{{ p.player.level }}</td>
                        {% endif %}
                        <td class="text-center py-1 px-1">{{ p.player.position }}</td>
                        <td class="text-center py-1 px-1">
                            {% if p.player.current_mlb_org %}
                                {{ p.player.current_mlb_org }}
                            {% elif p.player.get_best_stat_season and p.player.get_best_stat_season.mlb_org %}
                                {{ p.player.get_best_stat_season.mlb_org }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="text-center py-1 px-1 tier-assign-cell">
                            <button type="button" class="tier-assign-btn text-[10px] px-1 py-0.5 border border-gray-300 rounded mx-0.5 hover:bg-gray-200" data-playerid="{{ p.player.id }}" data-tier="1">1</button>
                            <button type="button" class="tier-assign-btn text-[10px] px-1 py-0.5 border border-gray-300 rounded mx-0.5 hover:bg-gray-200" data-playerid="{{ p.player.id }}" data-tier="2">2</button>
                            <button type="button" class="tier-assign-btn text-[10px] px-1 py-0.5 border border-gray-300 rounded mx-0.5 hover:bg-gray-200" data-playerid="{{ p.player.id }}" data-tier="3">3</button>
                            <button type="button" class="tier-assign-btn text-[10px] px-1 py-0.5 border border-gray-300 rounded mx-0.5 hover:bg-gray-200" data-playerid="{{ p.player.id }}" data-tier="4">4</button>
                            <button type="button" class="tier-assign-btn text-[10px] px-1 py-0.5 border border-gray-300 rounded mx-0.5 hover:bg-gray-200" data-playerid="{{ p.player.id }}" data-tier="5">5</button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>
</div>

<!-- {% include "includes/notes_modal.html" %} -->
{% endblock %}
        
{% block extrascript %}
<script src="//SortableJS.github.io/Sortable/Sortable.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>

{% if user.is_authenticated %}
<script type="text/javascript">
    // Flag used by wishlistjs to alter behaviour on draft wishlist pages
    window.WISHLIST_DRAFT_PAGE = true;
</script>
<script type="text/javascript">
$(function(){
    // Initialize tier counts and visual states on page load
    function initialize_tier_counts() {
        $('.tier-list').each(function(){
            var $tierBody = $(this);
            var tier = parseInt($tierBody.data('tier')) || 0;
            if (tier >= 1 && tier <= 5) {
                var count = $tierBody.children('tr.list-group-item').length;
                var $countEl = $('[data-tier-count="' + tier + '"]');
                if ($countEl.length) {
                    $countEl.text(count + '/20');
                    var $tierContainer = $('[data-tier-id="' + tier + '"]');
                    var $header = $tierContainer.find('.bg-gray-100, .bg-red-100');
                    if (count >= 20) {
                        $tierContainer.addClass('tier-full');
                        $header.removeClass('bg-gray-100').addClass('bg-red-100 border-red-300');
                        $countEl.removeClass('text-gray-600').addClass('text-red-600 font-bold');
                    } else {
                        $tierContainer.removeClass('tier-full');
                        $header.removeClass('bg-red-100 border-red-300').addClass('bg-gray-100');
                        $countEl.removeClass('text-red-600 font-bold').addClass('text-gray-600');
                    }
                }
            }
        });
        
        // Watched section is always visible (even when empty) so players can be dragged into it
        // No initialization needed
    }
    
    // Run on page load
    initialize_tier_counts();
    // Tiered drag-and-drop using Sortable across multiple tier lists
    var update_server = function(update_list) {
        if (update_list.length === 0) {
            return;
        }
        $.ajax({
            method: "POST",
            url: '/api/v1/wishlist/bulk/',
            data: JSON.stringify(update_list),
            success: function(response){
                console.log("Wishlist bulk update:", response);
            }
        });
    };

    var recompute_all_ranks = function() {
        var update_list = [];
        var MAX_TIER_SIZE = 20;

        $('.tier-list').each(function(){
            var $tierBody = $(this);
            var tier = parseInt($tierBody.data('tier')) || 0;
            var idx = 0;

            $tierBody.children('tr.list-group-item').each(function(){
                var $row = $(this);
                var playerid = $row.data('playerid');
                var name = $row.data('playername');

                // Only tier 1-5 get ranked within a tier; untiered (0) don't get ranks
                if (tier >= 1 && tier <= 5) {
                    idx += 1;
                    $row.attr('data-rank', idx);
                    update_list.push({
                        'playerid': playerid,
                        'rank': idx,
                        'tier': tier,
                        'name': name
                    });
                } else {
                    // Untiered: keep tier null/0, no rank needed
                    update_list.push({
                        'playerid': playerid,
                        'tier': null,
                        'name': name
                    });
                }
            });

            // Update tier counts in headers if present (show X/20 format)
            if (tier >= 1 && tier <= 5) {
                var $countEl = $('[data-tier-count="' + tier + '"]');
                if ($countEl.length) {
                    $countEl.text(idx + '/20');
                    // Update visual state based on count
                    var $tierContainer = $('[data-tier-id="' + tier + '"]');
                    var $header = $tierContainer.find('.bg-gray-100');
                    if (idx >= MAX_TIER_SIZE) {
                        $tierContainer.addClass('tier-full');
                        $header.removeClass('bg-gray-100').addClass('bg-red-100 border-red-300');
                        $countEl.removeClass('text-gray-600').addClass('text-red-600 font-bold');
                    } else {
                        $tierContainer.removeClass('tier-full');
                        $header.removeClass('bg-red-100 border-red-300').addClass('bg-gray-100');
                        $countEl.removeClass('text-red-600 font-bold').addClass('text-gray-600');
                    }
                }
            }
        });

        // Watched section is always visible (even when empty) so players can be dragged into it
        // No need to show/hide it

        update_server(update_list);
    };

    var on_sort_end = function(evt) {
        recompute_all_ranks();
    };

    var can_move_to_tier = function(tier, currentPlayerId, fromElement) {
        if (tier < 1 || tier > 5) {
            return true; // Can always move to untiered
        }
        var $targetBody = $('#tier-' + tier + '-players');
        if ($targetBody.length === 0) {
            return false;
        }
        var currentCount = $targetBody.children('tr.list-group-item').length;
        var maxSize = parseInt($targetBody.data('max-size')) || 20;
        
        // If player is already in this tier, allow the move (reordering within tier)
        var $existingRow = $targetBody.find('tr[data-playerid="' + currentPlayerId + '"]');
        if ($existingRow.length > 0) {
            return true;
        }
        
        // Also check if we're moving from the same tier (reordering)
        if (fromElement) {
            var fromTier = parseInt($(fromElement).closest('.tier-list').data('tier')) || 0;
            if (fromTier === tier) {
                return true; // Reordering within same tier is always allowed
            }
        }
        
        return currentCount < maxSize;
    };

    // Initialize Sortable on all tier lists (including watched/untiered with data-tier="0")
    $('.tier-list').each(function(){
        var $body = $(this);
        var tier = parseInt($body.data('tier')) || 0;
        
        Sortable.create(this, {
            group: 'wishlist-tiers',
            animation: 150,
            onEnd: on_sort_end,
            onMove: function(evt, originalEvent) {
                var targetTier = parseInt($(evt.to).data('tier')) || 0;
                var playerId = $(evt.dragged).data('playerid');
                return can_move_to_tier(targetTier, playerId, evt.from);
            }
        });
    });

    // Quick tier assignment from untiered pool: send directly to bottom of target tier
    $('body').on('click', '.tier-assign-btn', function(e){
        e.preventDefault();
        var $btn = $(this);
        var playerid = $btn.data('playerid');
        var tier = parseInt($btn.data('tier')) || 0;

        if (!tier || tier < 1 || tier > 5) {
            return;
        }

        var $row = $('#untiered-players tr.list-group-item[data-playerid="' + playerid + '"]');
        if ($row.length === 0) {
            // Also check if player is in another tier (allow moving between tiers)
            $row = $('.tier-list tr.list-group-item[data-playerid="' + playerid + '"]');
        }
        if ($row.length === 0) {
            return;
        }

        var $targetBody = $('#tier-' + tier + '-players');
        if ($targetBody.length === 0) {
            return;
        }

        // Check if tier is full
        if (!can_move_to_tier(tier, playerid)) {
            alert('Tier ' + tier + ' is full (20/20). Remove a player first or choose another tier.');
            return;
        }

        // Move the row to the bottom of the selected tier
        $row.appendTo($targetBody);

        // Recompute ranks and persist to server
        recompute_all_ranks();
    });
});
</script>

{% include "includes/my/wishlistjs.html" %}

<script type="text/javascript">
    $(function(){
    
        var persist_note_handler = function(el) {
            el.preventDefault();
            $el = $(this);

            var playerid = $el.attr('data-playerid');
            var note_text =  $('#note-textarea').val()

            $.ajax({
                type: "POST",
                data: {note: note_text},
                url: '/api/v1/wishlist/note/add/' + playerid + '/',
                success: function(response){
                    window.location.reload();
                }
            });

        }

        var close_modal_handler = function(el) {
            el.preventDefault();
            $el = $(this);
    
            var modalid = $el.parent('div').toggleClass('is-active');        
        }
    
        var note_modal_handler = function(el) {
            el.preventDefault();
            $el = $(this);
    
            var playerid = $el.parent('div').attr('data-playerid');
            var note_text = $el.parent('div').attr('data-note-text');
            var playername = $el.parent('div').attr('data-playername');

            $('#modal-title').html(playername);
            $('#note-textarea').val(note_text)
            $('#modal-notes').toggleClass('is-active');
            $('#persist-note').attr('data-playerid', playerid);
            
        }

        $('body').on('click', '#persist-note', persist_note_handler);
        $('body').on('click', 'span.note-control', note_modal_handler);
        $('body').on('click', 'button.modal-close', close_modal_handler);
        $('body').on('click', 'div.modal-background', close_modal_handler);
    });
</script>

<script type="text/javascript">
    $(function(){
        // Poll draft status and mark drafted players dynamically
        var draftYear = {{ draft_year }};
        var draftSeason = "{{ draft_season }}";
        var draftType = "{{ draft_type }}";
        var draftedPlayers = {};

        var apply_drafted_state = function(playerId, teamAbbr) {
            var selector = 'tr.list-group-item[data-playerid="' + playerId + '"]';
            var $rows = $(selector);
            if ($rows.length === 0) {
                return;
            }

            $rows.addClass('drafted');
            $rows.each(function(){
                var $row = $(this);
                var $ownerSpan = $row.find('.pickowner');
                if ($ownerSpan.length && teamAbbr) {
                    $ownerSpan.text(teamAbbr.toUpperCase());
                }
            });

            if ($('#hide-drafted-toggle').is(':checked')) {
                $rows.addClass('hide');
            }
        };

        var refresh_hide_toggle = function() {
            var hide = $('#hide-drafted-toggle').is(':checked');
            $('tr.list-group-item.drafted').each(function(){
                if (hide) {
                    $(this).addClass('hide');
                } else {
                    $(this).removeClass('hide');
                }
            });
        };

        $('#hide-drafted-toggle').on('change', function(){
            refresh_hide_toggle();
        });

        var poll_draft_status = function() {
            var url = '/api/v1/draft/watch/' + draftYear + '/' + draftSeason + '/' + draftType + '/';
            $.ajax({
                type: "GET",
                url: url,
                success: function(response){
                    if (!response.made_picks) {
                        return;
                    }
                    $.each(response.made_picks, function(idx, pick){
                        if (pick.player_id && !draftedPlayers[pick.player_id]) {
                            draftedPlayers[pick.player_id] = true;
                            apply_drafted_state(pick.player_id, pick.team);
                        }
                    });
                }
            });
        };

        // Initial poll and then repeat every 15 seconds
        poll_draft_status();
        setInterval(poll_draft_status, 15000);
    });
</script>
{% endif %}

{% endblock %}